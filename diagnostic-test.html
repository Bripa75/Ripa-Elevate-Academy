<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ripa Elevate Diagnostic — All-in-One (Grades 2–8)</title>
  <meta name="description" content="A futuristic, adaptive diagnostic for Math & ELA aligned to NYC/NYS standards. Free, private, and instant.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#070a12; --text:#eef2fb; --muted:#b7c0d9;
      --glass: rgba(255,255,255,.06); --stroke: rgba(255,255,255,.12);
      --accentA:#67e8f9; --accentB:#a78bfa;
      --radius:18px; --shadow: 0 20px 50px rgba(0,0,0,.5); --glow: 0 0 60px rgba(103,232,249,.35);
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:'Poppins',system-ui,Segoe UI,Roboto,Arial,sans-serif}
    a{color:inherit;text-decoration:none}
    .container{width:min(1200px,92%);margin:0 auto}

    header{position:sticky;top:0;z-index:20;backdrop-filter: blur(10px) saturate(140%);
      background:linear-gradient(180deg, rgba(7,10,18,.85), rgba(7,10,18,.5));border-bottom:1px solid var(--stroke)}
    header .row{display:flex;align-items:center;justify-content:space-between;padding:14px 0}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;letter-spacing:.2px}
    .orb{width:12px;height:12px;border-radius:50%;background:linear-gradient(135deg,var(--accentA),var(--accentB));box-shadow:var(--glow)}
    nav a{padding:10px 14px;border-radius:12px;opacity:.95;transition:.2s}
    nav a:hover{background:var(--glass)}

    .bg-gradient{
      position:fixed;inset:0;z-index:-2;
      background: radial-gradient(1200px 600px at 20% 10%, rgba(103,232,249,.12), transparent 40%),
                  radial-gradient(1200px 600px at 80% 80%, rgba(167,139,250,.12), transparent 40%);
      animation: floatBG 14s ease-in-out infinite alternate;
    }
    @keyframes floatBG{from{transform:translateY(-2%)}to{transform:translateY(2%)}}
    canvas#fx{position:fixed;inset:0;z-index:-1;opacity:.35;pointer-events:none}

    .hero{padding:86px 0 36px;text-align:center}
    h1.headline{font-size: clamp(28px, 5vw, 56px);line-height:1.05;margin:0 auto 10px;width:min(980px,95%);font-weight:700}
    .txt-grad{background:linear-gradient(90deg,var(--accentA),var(--accentB));-webkit-background-clip:text;background-clip:text;color:transparent}
    p.sub{font-size:clamp(16px,2.2vw,20px);color:var(--muted);margin:0 auto 18px;width:min(820px,92%)}
    .btns{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:12px}
    .btn{display:inline-flex;align-items:center;gap:10px;padding:14px 18px;border-radius:14px;border:1px solid var(--stroke);
      background:var(--glass);font-weight:600;transition:transform .08s ease, box-shadow .2s ease, background .2s ease; cursor:pointer}
    .btn.primary{background:linear-gradient(135deg, rgba(103,232,249,.18), rgba(167,139,250,.18));box-shadow:var(--glow)}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 28px rgba(0,0,0,.35)}
    .micro{color:var(--muted);font-size:14px;margin-top:8px}
    .accent-bar{height:3px;width:min(640px,80%);margin:22px auto;border-radius:999px;background:linear-gradient(90deg,var(--accentA),var(--accentB));
      position:relative;overflow:hidden;filter:blur(.2px)}
    .accent-bar::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.7),transparent);
      animation:shine 2.1s infinite linear}
    @keyframes shine{from{transform:translateX(-100%)}to{transform:translateX(100%)}}

    section{padding:56px 0; scroll-margin-top: 90px;}
    .label{letter-spacing:.14em;text-transform:uppercase;color:var(--muted);font-size:12px}
    .title{font-weight:700;font-size: clamp(22px, 3vw, 28px);margin:6px 0 10px}
    .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:16px;margin-top:16px}
    .card{background:var(--glass);border:1px solid var(--stroke);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);
      position:relative;transform-style:preserve-3d;transition:transform .15s ease}
    .card h3{margin:0 0 6px;font-size:18px}
    .card p{margin:0;color:var(--muted)}
    .card::before{content:"";position:absolute;inset:-1px;border-radius:inherit;padding:1px;
      background:linear-gradient(135deg, rgba(103,232,249,.28), rgba(167,139,250,.28));
      -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite:xor;mask-composite:exclude}

    .two-col{display:grid;grid-template-columns:1.1fr .9fr;gap:18px;align-items:center;margin-top:22px}
    .mock{background:linear-gradient(135deg, rgba(103,232,249,.12), rgba(167,139,250,.12));
      border:1px solid rgba(103,232,249,.28);border-radius:var(--radius);padding:18px;box-shadow:var(--glow)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .kpi{display:flex;flex-direction:column;align-items:flex-start;gap:4px}
    .kpi .num{font-size:28px;font-weight:700}
    .kpi .cap{color:var(--muted);font-size:13px}
    .bar{height:10px;background:rgba(255,255,255,.12);border-radius:8px;overflow:hidden;margin-top:10px}
    .fill{height:100%;width:66%;background:linear-gradient(90deg,var(--accentA),var(--accentB))}

    .heat{display:grid;grid-template-columns:repeat(6,1fr);gap:6px;margin-top:10px}
    .cell{height:18px;border-radius:6px;background:rgba(255,255,255,.14)}
    .cell:nth-child(3n){background:rgba(103,232,249,.55)}

    .cta{background:linear-gradient(135deg, rgba(103,232,249,.14), rgba(167,139,250,.14));border:1px solid rgba(103,232,249,.28);
      border-radius:var(--radius);padding:22px;text-align:center;box-shadow:var(--glow)}

    .faq{display:grid;gap:12px;margin-top:12px}
    .q{background:var(--glass);border:1px solid var(--stroke);border-radius:14px;padding:16px}
    .q strong{display:block;margin-bottom:6px}

    footer{border-top:1px solid var(--stroke);color:var(--muted);padding:28px 0 50px;text-align:center}

    /* reveal content is visible even if JS observer doesn’t fire */
    .reveal{opacity:1;transform:none}

    /* ===== Embedded EXAM styles ===== */
    .stage{background:var(--glass);border:1px solid var(--stroke);border-radius:18px;padding:18px;display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    .examCard{background:var(--glass);border:1px solid var(--stroke);border-radius:var(--radius);padding:16px}
    .examTitle{font-weight:700;font-size:22px;margin:0 0 6px}
    .examMuted{color:var(--muted);font-size:14px;margin:0 0 12px}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .kpiBox{background:var(--glass);border:1px solid var(--stroke);border-radius:12px;padding:12px;text-align:center}
    .kpiBox .num{font-size:22px;font-weight:700}
    .choices{display:grid;gap:10px}
    .choices button{padding:12px 14px;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.04);color:var(--text);text-align:left;font-weight:600;cursor:pointer}
    .choices button:hover{background:rgba(255,255,255,.08)}
    .qtext{font-size:18px;margin:0 0 10px}
    .progBar{height:10px;background:rgba(255,255,255,.12);border-radius:999px;overflow:hidden}
    .progFill{height:100%;width:0%;background:linear-gradient(90deg,var(--accentA),var(--accentB));transition:width .35s ease}

    @media (max-width: 900px){
      .grid3{grid-template-columns:1fr}
      .two-col{grid-template-columns:1fr}
      .stage{grid-template-columns:1fr}
      h1.headline{font-size: clamp(26px, 7vw, 38px)}
    }
  </style>
</head>
<body>
  <div class="bg-gradient" aria-hidden="true"></div>
  <canvas id="fx" aria-hidden="true"></canvas>

  <header>
    <div class="container">
      <div class="row">
        <div class="brand"><span class="orb"></span><span>Ripa Elevate Academy</span></div>
        <nav>
          <a href="/">Home</a>
          <a href="#how">How it works</a>
          <a href="#faq">FAQ</a>
          <a href="#exam">Start Test</a>
        </nav>
      </div>
    </div>
  </header>

  <main>
    <!-- HERO -->
    <section class="hero">
      <div class="container">
        <h1 class="headline">The <span class="txt-grad">Instant Learning Scan</span> for Math & ELA</h1>
        <p class="sub">A 40-minute (demo configurable), adaptive checkup that pinpoints level by skill and gives you an action plan—free, private, and built for families.</p>
        <div class="btns">
          <a class="btn primary" href="#exam">Start Free Diagnostic</a>
          <a class="btn" href="#how">See How It Works</a>
        </div>
        <div class="micro">No signup. Works on laptop or iPad.</div>
        <div class="accent-bar"></div>
      </div>
    </section>

    <!-- HOW IT WORKS -->
    <section id="how">
      <div class="container reveal">
        <div class="label">How it works</div>
        <div class="title">Simple steps. Smart results.</div>
        <div class="grid3">
          <div class="card tilt">
            <h3>Smart Start</h3>
            <p>We ask a few quick questions and route your child to the right difficulty.</p>
          </div>
          <div class="card tilt">
            <h3>Adaptive Checkup</h3>
            <p>Questions get easier or harder in real time to pinpoint level and skills.</p>
          </div>
          <div class="card tilt">
            <h3>Instant Results</h3>
            <p>You get a clear report with strengths, priorities, and a short action plan.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- MINI REPORT PREVIEW -->
    <section>
      <div class="container two-col reveal">
        <div>
          <div class="title">A clear report—no jargon</div>
          <p class="micro" style="margin:0 0 10px">Preview</p>
          <div class="row">
            <div class="kpi">
              <div class="num" data-count="4.3">0.0</div>
              <div class="cap">Current level</div>
            </div>
            <div class="kpi">
              <div class="num" data-count="5.0">0.0</div>
              <div class="cap">Expected level</div>
            </div>
            <div class="kpi">
              <div class="num" data-count="95">0</div>
              <div class="cap">Confidence (%)</div>
            </div>
          </div>
          <div class="bar"><div class="fill"></div></div>
          <p class="micro">You’ll also see strengths, priorities, and a 2- & 4-week practice plan.</p>
        </div>
        <div class="mock" aria-hidden="true">
          <div class="heat">
            <div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div>
            <div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div>
            <div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- CALL TO ACTION -->
    <section id="start">
      <div class="container reveal">
        <div class="cta">
          <h2 class="title" style="margin:0">Start Free Diagnostic</h2>
          <p class="micro" style="margin:8px 0 16px">No signup required. Works on laptop or iPad.</p>
          <a class="btn primary" href="#exam">Begin Now</a>
        </div>
      </div>
    </section>

    <!-- ===== EMBEDDED EXAM ===== -->
    <section id="exam">
      <div class="container">
        <div class="title">Instant Learning Scan — Demo (NYC/NYS aligned)</div>
        <p class="micro" style="margin:0 0 12px">Math + ELA • configurable length • live indicators • instant report</p>

        <!-- Exam Settings -->
        <div class="examCard" style="margin-bottom:14px">
          <div class="row" style="align-items:flex-end">
            <div>
              <div class="examTitle" style="margin:0 0 6px">Exam Settings</div>
              <p class="examMuted" style="margin:0">Choose grade focus and length. “Auto” adapts without a preset grade.</p>
            </div>
            <div class="btns" style="gap:10px;flex-wrap:wrap">
              <label class="examMuted">Grade:
                <select id="gradeSel" style="margin-left:6px">
                  <option value="">Auto</option>
                  <option>2</option><option>3</option><option>4</option>
                  <option>5</option><option>6</option><option>7</option><option>8</option>
                </select>
              </label>
              <label class="examMuted">Length:
                <select id="lenSel" style="margin-left:6px">
                  <option value="32">32</option>
                  <option value="48">48</option>
                  <option value="62" selected>62</option>
                </select>
              </label>
              <button class="btn" type="button" id="applyExam">Apply & Restart</button>
            </div>
          </div>
        </div>

        <!-- Live Exam -->
        <div class="stage" id="app" role="region" aria-live="polite">
          <!-- Left: question panel -->
          <div class="examCard">
            <div class="row">
              <div>
                <div class="examTitle" id="sectionTitle">Math — Question 1</div>
                <p class="examMuted" id="sectionHint">We’ll adjust difficulty as you go. Try your best!</p>
              </div>
              <div style="min-width:170px">
                <div class="examMuted" id="progressText" style="text-align:center">1 / 62</div>
                <div class="progBar" aria-label="Progress"><div class="progFill" id="progressFill"></div></div>
              </div>
            </div>
            <h3 class="qtext" id="qtext">Loading…</h3>
            <div class="choices" id="choices"></div>
          </div>

          <!-- Right: live indicators / mini-report -->
          <div class="examCard">
            <div class="examTitle">Live Indicators</div>
            <p class="examMuted">These update as answers come in.</p>
            <div class="kpis">
              <div class="kpiBox">
                <div class="examMuted">Estimated Level</div>
                <div class="num" id="estLevel">4.0</div>
              </div>
              <div class="kpiBox">
                <div class="examMuted">Confidence</div>
                <div class="num" id="confidence">—</div>
              </div>
              <div class="kpiBox">
                <div class="examMuted">Domain</div>
                <div class="num" id="domainNow">Math</div>
              </div>
            </div>
            <div style="margin-top:12px">
              <div class="examMuted">Strength signals</div>
              <div id="strengths"></div>
            </div>
            <div style="margin-top:8px">
              <div class="examMuted">Priority signals</div>
              <div id="needs"></div>
            </div>
            <div class="btns" style="margin-top:14px;justify-content:flex-start">
              <button class="btn" type="button" id="finishBtn">Finish now</button>
            </div>
          </div>
        </div>

        <!-- Report -->
        <div class="examCard" id="report" style="display:none;margin-top:16px">
          <div class="row">
            <div class="examTitle">Instant Report (Demo)</div>
            <div class="btns">
              <button class="btn" onclick="window.print()">Download as PDF</button>
              <a class="btn" href="#exam" onclick="location.reload()">Restart</a>
            </div>
          </div>
          <p class="examMuted">Estimates by domain, shows confidence, and recommends next steps. Targets reflect NYC/NYS grade expectations.</p>

          <!-- Current -->
          <div class="kpis">
            <div class="kpiBox">
              <div class="examMuted">Math level (current)</div>
              <div class="num" id="mathLevel">—</div>
            </div>
            <div class="kpiBox">
              <div class="examMuted">ELA level (current)</div>
              <div class="num" id="elaLevel">—</div>
            </div>
            <div class="kpiBox">
              <div class="examMuted">Overall confidence</div>
              <div class="num" id="confOut">—</div>
            </div>
          </div>

          <!-- Expected -->
          <div class="kpis" style="margin-top:10px">
            <div class="kpiBox">
              <div class="examMuted">Math expected (NYC/NYS)</div>
              <div class="num" id="mathExpected">—</div>
              <div class="examMuted" id="mathGap" style="margin-top:6px">—</div>
            </div>
            <div class="kpiBox">
              <div class="examMuted">ELA expected (NYC/NYS)</div>
              <div class="num" id="elaExpected">—</div>
              <div class="examMuted" id="elaGap" style="margin-top:6px">—</div>
            </div>
            <div class="kpiBox">
              <div class="examMuted">Grade reference</div>
              <div class="num" id="gradeRef">Select grade in settings</div>
            </div>
          </div>

          <!-- Skills -->
          <div style="margin-top:12px">
            <div class="examMuted">Strengths</div><div id="strengthList"></div>
          </div>
          <div style="margin-top:8px">
            <div class="examMuted">Priorities</div><div id="needList"></div>
          </div>

          <!-- Standards toggle -->
          <div style="margin-top:12px">
            <label class="examMuted" style="display:flex;align-items:center;gap:8px">
              <input type="checkbox" id="stdToggle"> Show standards details
            </label>
            <div id="stdDetails" style="display:none; margin-top:8px" class="examMuted"></div>
          </div>

          <!-- Plan -->
          <div style="margin-top:12px">
            <div class="examMuted">Action plan</div>
            <ul style="margin-top:6px">
              <li id="plan1">2-week: 10–15 mins/day targeted practice in priority areas.</li>
              <li id="plan2">4-week: Reassess with mini-check (10 mins) and adjust level.</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- FAQ -->
    <section id="faq">
      <div class="container reveal">
        <div class="title">Mini-FAQ</div>
        <div class="faq">
          <div class="q">
            <strong>What grades is this for?</strong>
            <span class="micro">Grades 2–8 in this demo, aligned to NYC/NYS standards.</span>
          </div>
          <div class="q">
            <strong>How long does it take?</strong>
            <span class="micro">Configurable: 32, 48, or 62 questions.</span>
          </div>
          <div class="q">
            <strong>Is my child’s data private?</strong>
            <span class="micro">Yes. This preview runs entirely in the browser—no data leaves the page.</span>
          </div>
          <div class="q">
            <strong>Can I talk to someone about the results?</strong>
            <span class="micro">Absolutely—your report includes a quick link to schedule a call.</span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      © <span id="year"></span> Ripa Elevate Academy · Private by design
    </div>
  </footer>

  <script>
    // year
    document.getElementById('year').textContent = new Date().getFullYear();

    // background particles
    const c = document.getElementById('fx');
    const ctx = c.getContext('2d');
    let w, h, particles;
    function resize(){ w = c.width = innerWidth; h = c.height = innerHeight; make(); }
    function make(){
      particles = Array.from({length: 80}, () => ({
        x: Math.random()*w, y: Math.random()*h, r: Math.random()*1.8+0.6,
        vx: (Math.random()-.5)*0.25, vy: (Math.random()-.5)*0.25
      }));
    }
    function step(){
      ctx.clearRect(0,0,w,h);
      ctx.fillStyle = 'rgba(255,255,255,.7)';
      for(const p of particles){
        p.x += p.vx; p.y += p.vy;
        if(p.x<0||p.x>w) p.vx*=-1; if(p.y<0||p.y>h) p.vy*=-1;
        ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
      }
      requestAnimationFrame(step);
    }
    addEventListener('resize', resize); resize(); step();

    // tilt cards
    document.querySelectorAll('.tilt').forEach(card => {
      card.addEventListener('mousemove', (e)=>{
        const r = card.getBoundingClientRect();
        const x = (e.clientX - r.left)/r.width - .5;
        const y = (e.clientY - r.top)/r.height - .5;
        card.style.transform = `rotateX(${(-y*6).toFixed(2)}deg) rotateY(${(x*6).toFixed(2)}deg)`;
      });
      card.addEventListener('mouseleave', ()=> card.style.transform = '');
    });

    // reveal-on-scroll (base CSS ensures visibility regardless)
    const obs = new IntersectionObserver((entries)=>{
      entries.forEach(e => { if(e.isIntersecting){ e.target.classList.add('show'); obs.unobserve(e.target); } });
    }, {threshold:.08});
    document.querySelectorAll('.reveal').forEach(el => obs.observe(el));

    // mini-KPI count animation
    const nums = document.querySelectorAll('.num[data-count]');
    const anim = (el, target, dur=1200, decimals=0) => {
      const start = performance.now(); const from = 0;
      const ease = t => t<.5 ? 4*t*t*t : 1 - Math.pow(-2*t+2,3)/2;
      function frame(now){
        const p = Math.min(1, (now-start)/dur); const v = from + (target-from)*ease(p);
        el.textContent = Number(v).toFixed(decimals);
        if(p<1) requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
    };
    const obs2 = new IntersectionObserver(entries => {
      entries.forEach(e=>{
        if(e.isIntersecting){
          nums.forEach(n => { const val = parseFloat(n.dataset.count); const dec = n.dataset.count.includes('.') ? 1 : 0; anim(n,val,1200,dec); });
          obs2.disconnect();
        }
      });
    }, {threshold:.4});
    const twoCol = document.querySelector('.two-col'); if(twoCol) obs2.observe(twoCol);

    /* =========================
       Embedded Exam JS — NYC/NYS-aligned (Gr 2–8), up to 62 Qs
       ========================= */
    (function(){
      // ---- Settings / State ----
      const DEFAULT_TOTAL = 62;
      const DEFAULT_GRADE = null; // null = Auto
      let chosenTotal = DEFAULT_TOTAL;
      let chosenGrade = DEFAULT_GRADE;

      let state = {
        step:0, total:DEFAULT_TOTAL, domain:'Math',
        mathCorrect:0, elaCorrect:0,
        est:4.0, conf:0.5, strengths:new Map(), needs:new Map()
      };

      // ---- Standards labels ----
      const STD = {
        M: {
          G2_OA_2:'NY-2.OA.2', G2_OA_3:'NY-2.OA.3',
          G3_NBT_4:'NY-3.NBT.*', G3_OA:'NY-3.OA.*', G3_NF:'NY-3.NF.*',
          G4_NF:'NY-4.NF.*', G4_MD:'NY-4.MD.*',
          G5_NBT:'NY-5.NBT.*', G5_NF:'NY-5.NF.*',
          G6_RP:'NY-6.RP.*', G6_NS:'NY-6.NS.*', G6_EE:'NY-6.EE.*',
          G7_NS:'NY-7.NS.*', G7_EE:'NY-7.EE.*', G7_G:'NY-7.G.*',
          G8_F:'NY-8.F.*', G8_G:'NY-8.G.*'
        },
        E: { RL:'NY-ELA.RL.*', RI:'NY-ELA.RI.*', L:'NY-ELA.L.*', W:'NY-ELA.W.*' }
      };

      // ---- Utils ----
      const rand = (n)=> Math.floor(Math.random()*n);
      const pick = (arr)=> arr[rand(arr.length)];
      function shuffle(arr){ return arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); }
      function bump(map, key, delta){ map.set(key, (map.get(key)||0) + delta); }
      function choiceSet(correct, wrongs){
        const opts = shuffle([correct, ...wrongs]).slice(0,4);
        return opts.length<4 ? shuffle([...opts, ...wrongs].slice(0,4)) : opts;
      }
      const within = (min,max)=> Math.floor(Math.random()*(max-min+1))+min;

      // ---- Math generators ----
      function genG2_OA_2(){ const a=within(1,10), b=within(1,10); const c=String(a+b);
        const wrongs=[a+b+1,a+b-1,a+b+2].filter(x=>x>0).map(String);
        return {t:`What is ${a} + ${b}?`, c, a:choiceSet(c,wrongs), tag:'arithmetic', std:STD.M.G2_OA_2, lvl:2.5}; }
      function genG2_OA_3(){ const n=within(2,99); const c=(n%2===0)?'Even':'Odd';
        return {t:`Is ${n} even or odd?`, c, a:choiceSet(c,['Even','Odd']), tag:'parity', std:STD.M.G2_OA_3, lvl:2.5}; }
      function genG3_NBT(){
        const th=within(1,9), h=within(0,9), t=within(0,9), o=within(0,9);
        const num = th*1000 + h*100 + t*10 + o;
        const mode = pick(['value','round10','round100']);
        if(mode==='value'){
          const digit = pick([['thousands',th,1000],['hundreds',h,100],['tens',t,10],['ones',o,1]]);
          const c = String(digit[1]*digit[2]); const wrongs=[digit[2],digit[1],digit[1]*10].map(String);
          return {t:`What is the value of the digit in the ${digit[0]} place of ${num}?`, c, a:choiceSet(c,wrongs), tag:'place-value', std:STD.M.G3_NBT_4, lvl:3.5};
        } else if(mode==='round10'){
          const rounded = Math.round(num/10)*10; const wrongs=[rounded+10,rounded-10,Math.round(num/100)*100];
          return {t:`Round ${num} to the nearest ten.`, c:String(rounded), a:choiceSet(String(rounded), wrongs.map(String)), tag:'rounding', std:STD.M.G3_NBT_4, lvl:3.5};
        } else {
          const rounded = Math.round(num/100)*100; const wrongs=[rounded+100,rounded-100,Math.round(num/10)*10];
          return {t:`Round ${num} to the nearest hundred.`, c:String(rounded), a:choiceSet(String(rounded), wrongs.map(String)), tag:'rounding', std:STD.M.G3_NBT_4, lvl:3.7};
        }
      }
      function genFracEquiv(){ const base=[[1,2],[2,3],[3,4]][rand(3)], k=within(2,4);
        const c=`${base[0]*k}/${base[1]*k}`; const wrongs=[`${base[0]}/${base[1]+1}`,`${base[0]+1}/${base[1]}`,`${base[0]*k}/${base[1]*k+1}`];
        return {t:`Which fraction is equivalent to ${base[0]}/${base[1]}?`, c, a:choiceSet(c,wrongs), tag:'fractions', std:STD.M.G3_NF, lvl:4.5}; }
      function genAddLikeDen(){ const den=pick([4,6,8,10,12]); const a1=within(1,den-1), a2=within(1,den-1);
        const num=a1+a2, c=`${num}/${den}`; const wrongs=[`${a1}/${den}`,`${a2}/${den}`,`${Math.abs(a1-a2)}/${den}`];
        return {t:`Compute: ${a1}/${den} + ${a2}/${den}`, c, a:choiceSet(c,wrongs), tag:'fractions', std:STD.M.G4_NF, lvl:4.8}; }
      function genAreaPerim(){ const w=within(3,12), h=within(3,12), mode=pick(['area','perim']);
        if(mode==='area'){ const c=String(w*h), wrongs=[w+h,w*h+2,w*h-2].map(String);
          return {t:`Area of a rectangle ${w} by ${h}?`, c, a:choiceSet(c,wrongs), tag:'geometry', std:STD.M.G4_MD, lvl:4.6}; }
        else { const p=2*(w+h); const wrongs=[w+h,p+2,p-2].map(String);
          return {t:`Perimeter of a rectangle ${w} by ${h}?`, c:String(p), a:choiceSet(String(p), wrongs), tag:'geometry', std:STD.M.G4_MD, lvl:4.6}; } }
      function genDecCompare(){ const a=(within(10,99)/100).toFixed(2), b=(within(10,99)/100).toFixed(2);
        const bigger=parseFloat(a)>parseFloat(b)?a:b; const wrongs=[(parseFloat(bigger)-0.01).toFixed(2),'Equal',(parseFloat(bigger)+0.01).toFixed(2)];
        return {t:`Which is greater? ${a} or ${b}`, c:bigger, a:choiceSet(bigger,wrongs), tag:'decimals', std:STD.M.G5_NBT, lvl:5.0}; }
      function genPercentOf(){ const base=[40,50,60,80,120][rand(5)], pct=[10,15,20,25,30][rand(5)];
        const c=String(Math.round(base*pct/100)); const wrongs=[Math.round(base*(pct+5)/100),Math.round(base*(pct-5)/100),Math.round(base*(pct)/100)+2].map(String);
        return {t:`What is ${pct}% of ${base}?`, c, a:choiceSet(c,wrongs), tag:'percent', std:STD.M.G6_RP, lvl:6.0}; }
      function genUnitRate(){ const qty=[3,4,5,6][rand(4)], cost=[6,8,10,12,15][rand(5)];
        const c=(cost/qty).toFixed(2); const wrongs=[(cost/(qty+1)).toFixed(2),(cost/(qty-1)).toFixed(2),(cost/qty+0.25).toFixed(2)];
        return {t:`${qty} apples cost $${cost}. Cost per apple?`, c, a:choiceSet(c,wrongs), tag:'unit-rate', std:STD.M.G6_RP, lvl:6.2}; }
      function genIntAddSub(){ const a=within(-9,9), b=within(-9,9); const c=String(a+b); const wrongs=[a-b,-a+b,a+b+1].map(String);
        return {t:`Compute: ${a} + (${b})`, c, a:choiceSet(c,wrongs), tag:'integers', std:STD.M.G7_NS, lvl:6.8}; }
      function genOneStepEq(){ const x=within(2,12), b=within(2,10); const c=String(x); const wrongs=[x+1,x-1,b,x+b].map(String);
        return {t:`Solve for x: x + ${b} = ${x+b}`, c, a:choiceSet(c,wrongs), tag:'equations', std:STD.M.G6_EE, lvl:6.5}; }
      function genTriangleAngle(){ const a1=within(35,85), a2=within(35,85); let cVal=180-a1-a2; if(cVal<=10)cVal+=20;
        const c=String(cVal), wrongs=[cVal+10,cVal-10,a1].map(String);
        return {t:`A triangle has angles ${a1}° and ${a2}°. Find the third angle.`, c, a:choiceSet(c,wrongs), tag:'angles', std:STD.M.G7_G, lvl:7.0}; }
      function genSlope(){ const x1=within(0,6), y1=within(0,10), x2=x1+within(1,6), y2=y1+within(-5,5);
        const c=String(((y2-y1)/(x2-x1)).toFixed(2)); const wrongs=[((y2-y1)/(x2-x1)+0.5).toFixed(2),((y2-y1)/(x2-x1)-0.5).toFixed(2),((y2+y1)/(x2-x1)).toFixed(2)];
        return {t:`Slope between (${x1},${y1}) and (${x2},${y2})?`, c, a:choiceSet(c,wrongs), tag:'functions', std:STD.M.G8_F, lvl:8.0}; }
      function genPyth(){ const a=[3,5,6,7][rand(4)], b=[4,12,8,24][rand(4)]; const cVal=Math.round(Math.sqrt(a*a+b*b));
        const c=String(cVal), wrongs=[a+b,cVal+1,cVal-1].map(String);
        return {t:`Right triangle legs ${a} and ${b}. Hypotenuse length?`, c, a:choiceSet(c,wrongs), tag:'pythagorean', std:STD.M.G8_G, lvl:8.0}; }

      const MATH_GENS = [genG2_OA_2,genG2_OA_3,genG3_NBT,genFracEquiv,genAddLikeDen,genAreaPerim,genDecCompare,genPercentOf,genUnitRate,genIntAddSub,genOneStepEq,genTriangleAngle,genSlope,genPyth];

      // ---- ELA generators ----
      const PASSAGES = [
        { text:`The clouds gathered and the wind howled. Soon, droplets tapped the window.`,
          qMI:{t:'What is most likely happening?', c:'A storm is starting', w:['A sunny day','A parade','A quiet night'], std:STD.E.RI},
          qINF:{t:'Which clue best supports your answer?', c:'Wind howled and droplets tapped the window', w:['The day is sunny','People are cheering','Birds are chirping'], std:STD.E.RI}
        },
        { text:`Many plants bend toward light. Gardeners rotate pots so stems stay straight.`,
          qMI:{t:'What is the main idea?', c:'Plants grow toward light', w:['Plants hate water','Pots are heavy','Gardens are loud'], std:STD.E.RI}
        },
        { text:`Maya practiced every day before the recital. When the curtain rose, she smiled with confidence.`,
          qINF:{t:'What can you infer?', c:'Maya felt ready to perform', w:['Maya forgot her part','Maya was late','Maya left early'], std:STD.E.RL}
        }
      ];
      const SYN = [['eager','excited'],['scarce','rare'],['plentiful','abundant'],['assist','help'],['silent','quiet'],['purchase','buy']];
      const ANT = [['scarce','plentiful'],['difficult','easy'],['ancient','modern'],['expand','shrink']];
      const HOMO = [{sent:`___ bringing ___ books over ___.`, c:`They're, their, there`, w:[`Their, there, they're`,`There, they're, their`,`They're, there, their`]}];
      const SV_AGR = [{t:`Choose the correct sentence.`, c:`The dogs run fast.`, w:[`The dogs runs fast.`,`The dog run fast.`,`The dogs running fast.`]}];
      const COMMA = [{t:`Which sentence uses the comma correctly?`, c:`After the game, we went for pizza.`, w:[`After the game we went, for pizza.`,`After, the game we went for pizza.`,`After the game we, went for pizza.`]}];

      function genFromPassage(){ const p=pick(PASSAGES); const use=p.qMI && p.qINF ? pick(['mi','inf']) : (p.qMI ? 'mi':'inf');
        const data=(use==='mi')? p.qMI:p.qINF;
        return {t:`Read: “${p.text}” ${data.t}`, c:data.c, a:choiceSet(data.c,data.w), tag:(use==='mi'?'mainidea':'inference'), std:data.std, lvl:5.0}; }
      function genSynonym(){ const [w,syn]=pick(SYN); const wrongs=shuffle(SYN.map(x=>x[1]).filter(x=>x!==syn)).slice(0,3);
        return {t:`Choose the best synonym for “${w}”.`, c:syn, a:choiceSet(syn,wrongs), tag:'vocab', std:STD.E.L, lvl:4.0}; }
      function genAntonym(){ const [w,ant]=pick(ANT); const wrongs=shuffle(ANT.map(x=>x[1]).filter(x=>x!==ant)).slice(0,3);
        return {t:`Choose the antonym of “${w}”.`, c:ant, a:choiceSet(ant,wrongs), tag:'vocab', std:STD.E.L, lvl:5.0}; }
      function genHomophone(){ const h=pick(HOMO); return {t:h.sent, c:h.c, a:choiceSet(h.c,h.w), tag:'homophones', std:STD.E.L, lvl:4.5}; }
      function genSV(){ const s=pick(SV_AGR); return {t:s.t, c:s.c, a:choiceSet(s.c,s.w), tag:'grammar', std:STD.E.L, lvl:4.5}; }
      function genComma(){ const s=pick(COMMA); return {t:s.t, c:s.c, a:choiceSet(s.c,s.w), tag:'punctuation', std:STD.E.L, lvl:4.5}; }
      function genContextClue(){ const blanks=[{sent:`She spoke in a ___ voice so she wouldn’t wake the baby.`, c:'soft', w:['loud','angry','rapid']},
        {sent:`The desert is known for its ___ rainfall.`, c:'scarce', w:['plentiful','daily','stormy']},
        {sent:`He was so ___ to start that he arrived early.`, c:'eager', w:['confused','tired','reluctant']}];
        const b=pick(blanks); return {t:b.sent, c:b.c, a:choiceSet(b.c,b.w), tag:'context', std:STD.E.RI, lvl:3.5}; }

      const ELA_GENS = [genFromPassage,genSynonym,genAntonym,genHomophone,genSV,genComma,genContextClue];

      // ---- Build pools by grade & length ----
      function buildPools(grade,total){
        const mTarget = Math.floor(total/2), eTarget = total - mTarget;
        const mPool = []; while(mPool.length < Math.max(90, mTarget*2)) mPool.push(pick(MATH_GENS)());
        const ePool = []; while(ePool.length < Math.max(90, eTarget*2)) ePool.push(pick(ELA_GENS)());
        return {mQ: shuffle(mPool).slice(0,mTarget), eQ: shuffle(ePool).slice(0,eTarget)};
      }

      // ---- Expected vs current helpers ----
      function expectedForGrade(g){
        if(!g) return null;
        const gg = Math.max(2, Math.min(8, Number(g)));
        return { math: gg*1.0, ela: gg*1.0 }; // simple band target per grade
      }
      function gapText(current, expected){
        if(expected===null) return 'Set a grade to see target';
        const diff = +(current - expected).toFixed(1);
        if(diff >= 0.3) return `Ahead (+${diff})`;
        if(diff <= -0.3) return `Below (${diff})`;
        return 'On track (±0.2)';
      }
      const TAG_TO_STD = {
        'arithmetic':'NY-3.OA.*','parity':'NY-2.OA.3','place-value':'NY-3.NBT.*','rounding':'NY-3.NBT.*',
        'fractions':'NY-3–5.NF.*','geometry':'NY-4.MD.*','decimals':'NY-5.NBT.*','percent':'NY-6.RP.*','unit-rate':'NY-6.RP.*',
        'integers':'NY-6–7.NS.*','equations':'NY-6–7.EE.*','angles':'NY-7.G.*','functions':'NY-8.F.*','pythagorean':'NY-8.G.*',
        'mainidea':'NY-ELA.RI/RL.*','inference':'NY-ELA.RI/RL.*','vocab':'NY-ELA.L.*','homophones':'NY-ELA.L.*',
        'grammar':'NY-ELA.L.*','punctuation':'NY-ELA.L.*','context':'NY-ELA.RI.*','text-evidence':'NY-ELA.RI/RL.*'
      };

      // ---- Runtime state ----
      let mQ=[], eQ=[];
      function initExam(){
        const gradeSel = document.getElementById('gradeSel');
        chosenGrade = gradeSel && gradeSel.value ? Number(gradeSel.value) : null;
        const lenSel = document.getElementById('lenSel');
        chosenTotal = lenSel && lenSel.value ? Number(lenSel.value) : DEFAULT_TOTAL;

        state = { step:0, total:chosenTotal, domain:'Math', mathCorrect:0, elaCorrect:0,
                  est: chosenGrade ? Number(chosenGrade) : 4.0, conf:0.5, strengths:new Map(), needs:new Map() };

        const pools = buildPools(chosenGrade, chosenTotal);
        mQ = pools.mQ; eQ = pools.eQ;

        document.getElementById('app').style.display='block';
        document.getElementById('report').style.display='none';
        renderQ();
      }

      function pickQuestion(){ if(state.step < mQ.length){ state.domain='Math'; return mQ[state.step]; } state.domain='ELA'; return eQ[state.step - mQ.length]; }
      function topTags(map, n=3){ return Array.from(map.entries()).sort((a,b)=>b[1]-a[1]).slice(0,n).map(x=>x[0]); }
      function renderTags(){
        const sEl=document.getElementById('strengths'), nEl=document.getElementById('needs');
        sEl.innerHTML = topTags(state.strengths,4).map(t=>`<span class="pill">${t}</span>`).join('') || '<span class="examMuted">—</span>';
        nEl.innerHTML = topTags(state.needs,4).map(t=>`<span class="pill">${t}</span>`).join('') || '<span class="examMuted">—</span>';
      }

      function renderQ(){
        const q = pickQuestion();
        document.getElementById('domainNow').textContent = state.domain;
        document.getElementById('progressText').textContent = (state.step+1)+' / '+state.total;
        document.getElementById('progressFill').style.width = ((state.step)/state.total*100)+'%';

        const idxWithinDomain = state.domain==='Math' ? (state.step+1) : (state.step - mQ.length + 1);
        document.getElementById('sectionTitle').textContent = `${state.domain} — Question ${idxWithinDomain}`;
        document.getElementById('sectionHint').textContent = state.domain==='Math' ? 'Grade-aligned skills. Try your best!' : 'Reading, language, and writing skills.';

        document.getElementById('qtext').textContent = q.t;
        const choices = document.getElementById('choices'); choices.innerHTML='';
        shuffle(q.a.slice()).forEach(opt=>{ const b=document.createElement('button'); b.textContent=opt; b.onclick=()=>answer(q,opt); choices.appendChild(b); });

        document.getElementById('estLevel').textContent = state.est.toFixed(1);
        document.getElementById('confidence').textContent = Math.round(state.conf*100)+'%';
        renderTags();
      }

      function answer(q,opt){
        const correct=(opt===q.c);
        if(correct){
          if(state.domain==='Math') state.mathCorrect++; else state.elaCorrect++;
          state.est = Math.min(8, state.est + (q.lvl>=state.est? 0.20:0.10));
          state.conf = Math.min(1, state.conf + 0.03);
          bump(state.strengths, q.tag, 1);
        }else{
          state.est = Math.max(2, state.est - 0.08);
          state.conf = Math.max(0.2, state.conf - 0.02);
          bump(state.needs, q.tag, 1);
        }

        state.step++;
        if(state.step>=state.total){ finish(); } else { renderQ(); }
      }

      function finish(){
        document.getElementById('progressFill').style.width = '100%';

        // simple current levels
        const mathLevel = Math.min(8, Math.max(2, (chosenGrade || 5) + (state.mathCorrect - (state.total/2)/2)*0.1));
        const elaLevel  = Math.min(8, Math.max(2, (chosenGrade || 5) + (state.elaCorrect  - (state.total/2)/2)*0.1));
        document.getElementById('mathLevel').textContent = mathLevel.toFixed(1);
        document.getElementById('elaLevel').textContent  = elaLevel.toFixed(1);
        document.getElementById('confOut').textContent   = Math.round(state.conf*100)+'%';

        // strengths / needs lists
        const strengths = topTags(state.strengths,6).map(t=>`<span class="pill">${t}</span>`).join('') || '—';
        const needs = topTags(state.needs,6).map(t=>`<span class="pill">${t}</span>`).join('') || '—';
        document.getElementById('strengthList').innerHTML = strengths;
        document.getElementById('needList').innerHTML = needs;

        // expected vs current
        const exp = expectedForGrade(chosenGrade);
        const mathExp = exp ? exp.math : null;
        const elaExp  = exp ? exp.ela  : null;
        document.getElementById('mathExpected').textContent = (mathExp!==null) ? mathExp.toFixed(1) : '—';
        document.getElementById('elaExpected').textContent  = (elaExp!==null)  ? elaExp.toFixed(1)  : '—';
        document.getElementById('mathGap').textContent = gapText(parseFloat(document.getElementById('mathLevel').textContent), mathExp);
        document.getElementById('elaGap').textContent  = gapText(parseFloat(document.getElementById('elaLevel').textContent),  elaExp);
        document.getElementById('gradeRef').textContent = chosenGrade ? `Grade ${chosenGrade}` : 'Select grade in settings';

        // standards detail panel
        function chipsFromMap(map){
          const arr = Array.from(map.entries()).sort((a,b)=>b[1]-a[1]).slice(0,8);
          if(!arr.length) return '—';
          return arr.map(([tag,_count])=>{
            const std = TAG_TO_STD[tag] || '—';
            return `<div class="pill">${tag}</div><div class="examMuted" style="margin:2px 0 8px">${std}</div>`;
          }).join('');
        }
        const stdBox = document.getElementById('stdDetails');
        if(stdBox){
          stdBox.innerHTML = `
            <div><strong>Skill → Standards family</strong></div>
            ${chipsFromMap(new Map([...state.strengths, ...state.needs]))}
          `;
        }
        const stdToggle = document.getElementById('stdToggle');
        if(stdToggle){ stdToggle.checked=false; stdToggle.onchange=()=>{ stdBox.style.display = stdToggle.checked ? 'block':'none'; }; }

        document.getElementById('app').style.display='none';
        document.getElementById('report').style.display='block';
        document.getElementById('report').scrollIntoView({behavior:'smooth'});
      }

      // Apply & Restart
      const applyBtn = document.getElementById('applyExam');
      if(applyBtn){ applyBtn.addEventListener('click', ()=>{ initExam(); document.getElementById('exam').scrollIntoView({behavior:'smooth'}); }); }

      // Finish now
      document.getElementById('finishBtn').onclick = finish;

      // Start once
      initExam();
    })();
  </script>
</body>
</html>
